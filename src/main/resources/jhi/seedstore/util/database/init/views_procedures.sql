DROP VIEW IF EXISTS `view_table_containers`;
CREATE ALGORITHM = UNDEFINED SQL SECURITY DEFINER VIEW `view_table_containers` AS select `c`.`id` as `container_id`, `c`.`barcode` as `container_barcode`, `c`.`description` as `container_description`, `container_types`.`id` as `container_type_id`, `container_types`.`name` as `container_type_name`, `container_types`.`description` as `container_type_description`, `container_types`.`icon` as `container_type_icon`, `cp`.`id` as `parent_id`, `cp`.`barcode` as `parent_barcode`, `cp`.`description` as `parent_description`, `c`.`is_active` as `container_is_active`, `trials`.`id` as `trial_id`, `trials`.`name` as `trial_name`, `trials`.`description` as `trial_description`, `projects`.`id` as `project_id`, `projects`.`name` as `project_name`, `projects`.`description` as `project_description`, ( select json_arrayagg(json_object('attributeId', `attributes`.`id`, 'attributeName', `attributes`.`name`, 'attributeValue', `container_attributes`.`attribute_value`)) from (`container_attributes` left join `attributes` on ((`attributes`.`id` = `container_attributes`.`attribute_id`))) where (`container_attributes`.`container_id` = `c`.`id`)) as `container_attributes`, ( select count(1) from `containers` `sc` where `sc`.`parent_container_id` = `c`.`id`) as `sub_container_count`, `c`.`created_on` as `created_on` from `containers` `c` left join `containers` `cp` on `c`.`parent_container_id` = `cp`.`id` left join `container_types` on `c`.`container_type_id` = `container_types`.`id` left join `trials` on `trials`.`id` = `c`.`trial_id` left join `projects` on `projects`.`id` = `c`.`project_id`;

DROP VIEW IF EXISTS `view_table_transfers`;
CREATE ALGORITHM = UNDEFINED SQL SECURITY DEFINER VIEW `view_table_transfers` AS select `transfer_logs`.`id` as `transfer_log_id`, `c`.`id` as `container_id`, `c`.`barcode` as `container_barcode`, `c`.`description` as `container_description`, `s`.`id` as `source_id`, `s`.`barcode` as `source_barcode`, `s`.`description` as `source_description`, `t`.`id` as `target_id`, `t`.`barcode` as `target_barcode`, `t`.`description` as `target_description`, `transfer_logs`.`user_id` as `user_id`, `transfer_logs`.`created_on` as `created_on`, `transfer_logs`.`updated_on` as `updated_on` from `transfer_logs` left join `containers` `c` on `c`.`id` = `transfer_logs`.`container_id` left join `containers` `s` on `s`.`id` = `transfer_logs`.`source_id` left join `containers` `t` on `t`.`id` = `transfer_logs`.`target_id`;

DROP VIEW IF EXISTS `view_table_transfer_events`;
CREATE ALGORITHM = UNDEFINED SQL SECURITY DEFINER VIEW `view_table_transfer_events` AS select DATE(`transfer_logs`.`created_on`) as `date`, `s`.`id` as `source_id`, `s`.`barcode` as `source_barcode`, `st`.`name` as `source_type`, `t`.`id` as `target_id`, `t`.`barcode` as `target_barcode`, `tt`.`name` as `target_type`, `transfer_logs`.`user_id` as `user_id`, count(1) as `container_count` from `transfer_logs` left join `containers` `s` on `transfer_logs`.`source_id` = `s`.`id` left join `containers` `t` on `transfer_logs`.`target_id` = `t`.`id` left join `container_types` `st` on `st`.`id` = `s`.`container_type_id` left join `container_types` `tt` on `tt`.`id` = `t`.`container_type_id` group by `transfer_logs`.`source_id`, `transfer_logs`.`target_id`, `transfer_logs`.`user_id`, DATE(`transfer_logs`.`created_on`);